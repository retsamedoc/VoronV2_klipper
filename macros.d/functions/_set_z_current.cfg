[gcode_macro _SET_Z_CURRENT]
description: Function: lowers Z motor current during HOME, QGL, and other critical calibration moves.
variable_last_val: 'RUN'
gcode:
  {% if params.VAL == 'HOME' %}
    {% set z_run   = 0.3 %}
  {% else %}
    {% set z_run   = printer.configfile.settings["tmc2209 stepper_z"]["run_current"] %}
  {% endif %}
  {% if params.VAL != printer["gcode_macro _SET_Z_CURRENT"].last_val|string  %}
    SET_GCODE_VARIABLE MACRO=_SET_Z_CURRENT VARIABLE=last_val VALUE='"{params.VAL}"'
    {action_respond_info("Home&Probe: RunCur %.2f " % (z_run|float)}
    SET_TMC_CURRENT STEPPER=stepper_z  CURRENT={z_run}
    SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={z_run}
    SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT={z_run}
    SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT={z_run}
    M400
  {% endif %}
