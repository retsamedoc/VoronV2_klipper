[gcode_macro M1181]
description: To implement a more expressive tool change notification (called at tool change start, hence the +1 on swaps)
# parameters are CE for integer current extruder, NE for integer next extruder, TC for integer total tool changes
# reports total tool changes when wipe tower (WT) is in play, as WT is req'd for slicer to report total tool changes
# called from slicer tool change M1181 CE1 NE2 TC6 (or M1181 CE-1 NE2 TC6 for initial load)
gcode:
	{% set svv = printer.save_variables.variables %}
	
	{% set sp = " " %}
	{% set sl = "/" %}
	{% set at = "@" %}
	{% set gt = ">" %}
	{% set pi = "|" %}
	{% set op = "(" %}
	{% set cp = ")" %}
	{% set ps = "%" %}
#	{% set co = "," %}
#	{% set ns = "-" %}
	
	{% set ce = params.CE|int|default(-2) %}
	{% set ne = params.NE|int|default(-2) %}
	{% set tc = params.TC|int|default(0) %}
	
	{% if tc == 0 %}
		{% set this_tool = sp ~ "T" ~ ce %}
	{% else %}
		{% set this_tool = "T" ~ ce %}
	{% endif %}
	
	{% set this_swap = "S:" ~ (svv.ercf_swaps + 1) %}
	{% set total_swaps = sl ~ tc ~ sp %}
	{% set next_tool = gt ~ "T" ~ ne ~ sp %} 
	{% set sdcard_pos = at ~ "S" ~ printer.virtual_sdcard.file_position %}
	{% set sdcard_pct = sp ~ op ~ (printer.virtual_sdcard.progress*100)|round(2,'common') ~ ps ~ cp %}
	{% set interactions = sp ~ "I:" ~ svv.ercf_interactions ~ sp %}
	{% set xyz_pos = 	pi ~ "X" ~ printer.toolhead.position.x|round(3,'common') ~
						sp ~ "Y" ~ printer.toolhead.position.y|round(3,'common') ~ 
						sp ~ "Z" ~ printer.toolhead.position.z|round(3,'common') %}

	# initial swap
	{% if ce == -1  %}
		{% if tc > 0  %}
			# wipe tower initial
			{% set swap_msg = this_swap ~ total_swaps ~ " (Initial Load): " ~ next_tool ~ interactions ~ sdcard_pos ~ sdcard_pct ~ xyz_pos%}
			{% set lcd_swap_msg = this_swap ~ total_swaps ~ next_tool ~ interactions %}
			
			M118 {swap_msg}

			save_variable VARIABLE=last_swap_msg VALUE='"{swap_msg}"'
			save_variable VARIABLE=last_lcd_swap_msg VALUE='"{lcd_swap_msg}"'

		{% else %}
			# non-wipe tower initial
			{% set swap_msg = this_swap ~ " (Initial Load): " ~ next_tool ~ interactions ~ sdcard_pos ~ sdcard_pct ~ xyz_pos%}
			{% set lcd_swap_msg = this_swap ~ next_tool ~ interactions %}

			M118 {swap_msg}

			save_variable VARIABLE=last_swap_msg VALUE='"{swap_msg}"'
			save_variable VARIABLE=last_lcd_swap_msg VALUE='"{lcd_swap_msg}"'

		{% endif %}
	{% elif ce == ne %}
		#do nothing as no swap will occur - shouldn't get here in theory.?.
	
	# non-initial swaps
	{% else %}				
		{% if tc > 0  %} 
			# in process with wipe tower
			{% set swap_msg = this_swap ~ total_swaps ~ this_tool ~ next_tool ~ interactions ~ sdcard_pos ~ sdcard_pct ~ xyz_pos%}
			{% set lcd_swap_msg = this_swap ~ total_swaps ~ this_tool ~ next_tool ~ interactions %}
			
			M118 {swap_msg}

			save_variable VARIABLE=last_swap_msg VALUE='"{swap_msg}"'
			save_variable VARIABLE=last_lcd_swap_msg VALUE='"{lcd_swap_msg}"'

		{% else %}
			#in process no wipe tower
			{% set swap_msg = this_swap ~ this_tool ~ next_tool ~ interactions ~ sdcard_pos ~ sdcard_pct ~ xyz_pos%}
			{% set lcd_swap_msg = this_swap ~ this_tool ~ next_tool ~ interactions %}
			
			M118 {swap_msg}
			
			save_variable VARIABLE=last_swap_msg VALUE='"{swap_msg}"'
			save_variable VARIABLE=last_lcd_swap_msg VALUE='"{lcd_swap_msg}"'

		{% endif %}
	{% endif %}
