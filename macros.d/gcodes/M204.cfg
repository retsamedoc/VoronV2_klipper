# M204 - Set Starting Acceleration
[gcode_macro M204]
description: wrap FW proc to trap and make use of set_velocity_limit in a manner that I want
rename_existing: M204.1
gcode:

	{% if printer["gcode_macro _printer_vars"].ptr_verb_codeflow %} _proc_start function=M204 func_params='"{rawparams|string}"'  {% endif %}

	{% set ext_move_accel = params.P|default(0)|int %}
	{% set tvl_move_accel = params.T|default(0)|int %}
	{% set all_move_accel = params.S|default(0)|int %}
	{% set retract_accel  = params.R|default(0)|int %}

	{% set max_accel_limit = printer.toolhead.max_accel %}

	{% if all_move_accel %}
		# S param passed - cap at max accel limit and do it
		{% if all_move_accel > max_accel_limit %}
			{% set all_move_accel = max_accel_limit %}
		{% endif %}
		SET_VELOCITY_LIMIT ACCEL={all_move_accel} ACCEL_TO_DECEL={all_move_accel / 2}
	{% elif ext_move_accel and tvl_move_accel %}
		# P and T params passed - choose lesser of P and T, cap at max accel limit, and do it
		{% if ext_move_accel < tvl_move_accel %}
			{% set tgt_move_accel = ext_move_accel %}
		{% else %}
			{% set tgt_move_accel = tvl_move_accel %}
		{% endif %}
		{% if tgt_move_accel > max_accel_limit %}
			{% set tgt_move_accel = max_accel_limit %}
		{% endif %}
		SET_VELOCITY_LIMIT ACCEL={tgt_move_accel} ACCEL_TO_DECEL={tgt_move_accel / 2}
	{% elif ext_move_accel and not tvl_move_accel %}
		# P not T params passed - cap P at max accel limit, and do it
		{% if ext_move_accel > max_accel_limit %}
			{% set ext_move_accel = max_accel_limit %}
		{% endif %}
		SET_VELOCITY_LIMIT ACCEL={ext_move_accel} ACCEL_TO_DECEL={ext_move_accel / 2}
	{% elif tvl_move_accel and not ext_move_accel %}
		# T not P params passed - cap T at max accel limit, and do it
		{% if tvl_move_accel > max_accel_limit %}
			{% set tvl_move_accel = max_accel_limit %}
		{% endif %}
		SET_VELOCITY_LIMIT ACCEL={tvl_move_accel} ACCEL_TO_DECEL={tvl_move_accel / 2}
	{% elif retract_accel %}
		# do nothing here
	{% else %}
		# do nothing here
	{% endif %}

	{% if printer["gcode_macro _printer_vars"].ptr_verb_codeflow %} _proc_end function=M204 {% endif %}
